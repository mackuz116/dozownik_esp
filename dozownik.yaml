esphome:
  name: dozownik-nawozow
  friendly_name: "Dozownik V3.1 - WROOM"

esp32:
  board: esp32dev
  framework:
    type: arduino



# 1. Włączamy obsługę zapytań HTTP
http_request:
  useragent: esphome/device
  timeout: 15s
  verify_ssl: false  # To uciszy błąd kompilatora

preferences:
  flash_write_interval: 1min  # Wyłączamy auto-zapis (używamy Twojego sync)

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  power_save_mode: NONE

web_server:
  port: 80
  version: 2

api:
  encryption:
    key: !secret api_encryption_key
  password: !secret ota_password


ota:
  - platform: esphome

i2c:
  sda: 21
  scl: 22
  scan: true
  frequency: 400kHz


ads1115:
  - address: 0x48
    id: ads_hub

one_wire:
  - platform: gpio
    pin: GPIO4  # Zmień na pin, do którego fizycznie wpiąłeś żółty kabel

logger:
  level: DEBUG


# odkomentować po odpaleniu czujnikówsssddd
# interval:
#   - interval: 10min
#     then:
#       - http_request.get:
#           url: !lambda |-
#             char url[250];
#             // TU WKLEJ SWÓJ LINK Z GOOGLE (pomiędzy cudzysłów)
#             const char* base_url = "https://script.google.com/macros/s/AKfycbxi8G0N5jUF9fDgPCwcEO6nfc6wcEVyZff2Etf-ZoIC1acMMf-AaNcCrpLiRXcuXPs4/exec";
#             sprintf(url, "%s?temp=%.1f&ph=%.2f&tds=%.0f", 
#                     base_url, id(temp_akwarium).state, id(ph_akwarium).state, id(tds_real).state);
#             return url;

time:
  - platform: ds1307
    id: ds_time
    timezone: "Europe/Warsaw"
    update_interval: 1min
    on_time:
      - seconds: 0
        then:
          # --- POMPA 1 ---
          - if:
              condition:
                lambda: |-
                  auto now = id(ds_time).now();
                  int h = (int)id(h_p1).state;
                  int m = (int)id(m_p1).state;
                  if (!((now.hour == h && now.minute == m) && (h != 0 || m != 0))) return false;
                  
                  int dow = now.day_of_week; 
                  if (dow == 1) return id(p1_mon).state;
                  if (dow == 2) return id(p1_tue).state;
                  if (dow == 3) return id(p1_wed).state;
                  if (dow == 4) return id(p1_thu).state;
                  if (dow == 5) return id(p1_fri).state;
                  if (dow == 6) return id(p1_sat).state;
                  if (dow == 7) return id(p1_sun).state;
                  return false;
              then:
                - script.execute: script_p1

          # --- POMPA 2 ---
          - if:
              condition:
                lambda: |-
                  auto now = id(ds_time).now();
                  int h = (int)id(h_p2).state;
                  int m = (int)id(m_p2).state;
                  if (!((now.hour == h && now.minute == m) && (h != 0 || m != 0))) return false;

                  int dow = now.day_of_week;
                  if (dow == 1) return id(p2_mon).state;
                  if (dow == 2) return id(p2_tue).state;
                  if (dow == 3) return id(p2_wed).state;
                  if (dow == 4) return id(p2_thu).state;
                  if (dow == 5) return id(p2_fri).state;
                  if (dow == 6) return id(p2_sat).state;
                  if (dow == 7) return id(p2_sun).state;
                  return false;
              then:
                - script.execute: script_p2

          # --- POMPA 3 ---
          - if:
              condition:
                lambda: |-
                  auto now = id(ds_time).now();
                  int h = (int)id(h_p3).state;
                  int m = (int)id(m_p3).state;
                  if (!((now.hour == h && now.minute == m) && (h != 0 || m != 0))) return false;

                  int dow = now.day_of_week;
                  if (dow == 1) return id(p3_mon).state;
                  if (dow == 2) return id(p3_tue).state;
                  if (dow == 3) return id(p3_wed).state;
                  if (dow == 4) return id(p3_thu).state;
                  if (dow == 5) return id(p3_fri).state;
                  if (dow == 6) return id(p3_sat).state;
                  if (dow == 7) return id(p3_sun).state;
                  return false;
              then:
                - script.execute: script_p3

          # --- POMPA 4 ---
          - if:
              condition:
                lambda: |-
                  auto now = id(ds_time).now();
                  int h = (int)id(h_p4).state;
                  int m = (int)id(m_p4).state;
                  if (!((now.hour == h && now.minute == m) && (h != 0 || m != 0))) return false;

                  int dow = now.day_of_week;
                  if (dow == 1) return id(p4_mon).state;
                  if (dow == 2) return id(p4_tue).state;
                  if (dow == 3) return id(p4_wed).state;
                  if (dow == 4) return id(p4_thu).state;
                  if (dow == 5) return id(p4_fri).state;
                  if (dow == 6) return id(p4_sat).state;
                  if (dow == 7) return id(p4_sun).state;
                  return false;
              then:
                - script.execute: script_p4

          # --- POMPA 5 ---
          - if:
              condition:
                lambda: |-
                  auto now = id(ds_time).now();
                  int h = (int)id(h_p5).state;
                  int m = (int)id(m_p5).state;
                  if (!((now.hour == h && now.minute == m) && (h != 0 || m != 0))) return false;

                  int dow = now.day_of_week;
                  if (dow == 1) return id(p5_mon).state;
                  if (dow == 2) return id(p5_tue).state;
                  if (dow == 3) return id(p5_wed).state;
                  if (dow == 4) return id(p5_thu).state;
                  if (dow == 5) return id(p5_fri).state;
                  if (dow == 6) return id(p5_sat).state;
                  if (dow == 7) return id(p5_sun).state;
                  return false;
              then:
                - script.execute: script_p5

          # --- POMPA 6 ---
          - if:
              condition:
                lambda: |-
                  auto now = id(ds_time).now();
                  int h = (int)id(h_p6).state;
                  int m = (int)id(m_p6).state;
                  if (!((now.hour == h && now.minute == m) && (h != 0 || m != 0))) return false;

                  int dow = now.day_of_week;
                  if (dow == 1) return id(p6_mon).state;
                  if (dow == 2) return id(p6_tue).state;
                  if (dow == 3) return id(p6_wed).state;
                  if (dow == 4) return id(p6_thu).state;
                  if (dow == 5) return id(p6_fri).state;
                  if (dow == 6) return id(p6_sat).state;
                  if (dow == 7) return id(p6_sun).state;
                  return false;
              then:
                - script.execute: script_p6

  - platform: sntp
    id: sntp_time
    timezone: "Europe/Warsaw"


sensor:
  
  # - platform: template
  #   name: "Manualne pH"
  #   id: ph_sensor_id
  #   lambda: 'return 6.85;'
  
  - platform: ads1115
    multiplexer: 'A0_GND'
    gain: 4.096
    name: "TDS Voltage"
    id: tds_voltage
    update_interval: 5s
    unit_of_measurement: "V"

  - platform: ads1115
    multiplexer: 'A1_GND'
    gain: 4.096
    name: "pH Akwarium"
    id: ph_akwarium
    unit_of_measurement: "pH"
    accuracy_decimals: 2
    update_interval: 5s
    filters:
      - calibrate_linear:
          # (napięcie -> wartość pH)
          - 3.155 -> 6.86
          - 3.600 -> 4.01
      - median: # Ten filtr usunie pojedyncze błędy (jak ten Error 263 z logów)
          window_size: 7
          send_every: 4
          send_first_at: 1

  - platform: dallas_temp
    name: "Temperatura Akwarium"
    id: temp_akwarium
    update_interval: 10s
    unit_of_measurement: "°C"
    accuracy_decimals: 1


  - platform: template
    name: "TDS Akwarium"
    id: tds_real
    unit_of_measurement: "ppm"
    accuracy_decimals: 0
    lambda: |-
      float voltage = id(tds_voltage).state;
      float temp = id(temp_akwarium).state;
      
      // Jeśli napięcie jest za niskie lub czujnik temp nie odczytał danych (NaN)
      if (voltage < 0.1 || isnan(temp)) return 0.0;
      
      // Standardowy wzór na kompensację temperatury (odniesienie do 25°C)
      // Współczynnik 0.02 (2%) jest optymalny dla wody akwariowej
      float compensationCoefficient = 1.0 + 0.02 * (temp - 25.0);
      float compensationVoltage = voltage / compensationCoefficient;
      
      // Obliczamy TDS z wielomianu bazowego
      float base = (133.42 * pow(compensationVoltage, 3) - 255.86 * pow(compensationVoltage, 2) + 857.39 * compensationVoltage);
      
      // Twój indywidualny mnożnik kalibracji
      return base * 0.85;
    update_interval: 10s
        
# --- SKRYPTY DAWKOWANIA Z REGULACJĄ PRĘDKOŚCI I SOFT-STARTEM ---
script:
  - id: script_p1
    mode: queued
    then:
      - light.turn_on:
          id: p1
          brightness: !lambda "return id(p1_speed).state / 100.0;"
      - delay: !lambda "return id(d1).state * id(c1).state * 1000;"
      - light.turn_off: p1
      - lambda: |-
          auto call = id(p1_level).make_call();
          call.set_value(max(0.0f, id(p1_level).state - id(d1).state));
          call.perform();
          global_preferences->sync();

  - id: script_p2
    mode: queued
    then:
      - light.turn_on:
          id: p2
          brightness: !lambda "return id(p2_speed).state / 100.0;"
      - delay: !lambda "return id(d2).state * id(c2).state * 1000;"
      - light.turn_off: p2
      - lambda: |-
          auto call = id(p2_level).make_call();
          call.set_value(max(0.0f, id(p2_level).state - id(d2).state));
          call.perform();
          global_preferences->sync();

  - id: script_p3
    mode: queued
    then:
      - light.turn_on:
          id: p3
          brightness: !lambda "return id(p3_speed).state / 100.0;"
      - delay: !lambda "return id(d3).state * id(c3).state * 1000;"
      - light.turn_off: p3
      - lambda: |-
          auto call = id(p3_level).make_call();
          call.set_value(max(0.0f, id(p3_level).state - id(d3).state));
          call.perform();
          global_preferences->sync();

  - id: script_p4
    mode: queued
    then:
      - light.turn_on:
          id: p4
          brightness: !lambda "return id(p4_speed).state / 100.0;"
      - delay: !lambda "return id(d4).state * id(c4).state * 1000;"
      - light.turn_off: p4
      - lambda: |-
          auto call = id(p4_level).make_call();
          call.set_value(max(0.0f, id(p4_level).state - id(d4).state));
          call.perform();
          global_preferences->sync();

  - id: script_p5
    mode: queued
    then:
      - light.turn_on:
          id: p5
          brightness: !lambda "return id(p5_speed).state / 100.0;"
      - delay: !lambda "return id(d5).state * id(c5).state * 1000;"
      - light.turn_off: p5
      - lambda: |-
          auto call = id(p5_level).make_call();
          call.set_value(max(0.0f, id(p5_level).state - id(d5).state));
          call.perform();
          global_preferences->sync();

  - id: script_p6
    mode: queued
    then:
      - light.turn_on:
          id: p6
          brightness: !lambda "return id(p6_speed).state / 100.0;"
      - delay: !lambda "return id(d6).state * id(c6).state * 1000;"
      - light.turn_off: p6
      - lambda: |-
          auto call = id(p6_level).make_call();
          call.set_value(max(0.0f, id(p6_level).state - id(d6).state));
          call.perform();
          global_preferences->sync();

  - id: script_podmiana_uderzenie
    mode: queued
    then:
      - logger.log: "INFO: Start bezpiecznej dawki po podmianie (P1-P6)..."
      
      # --- POMPA 1 ---
      - if:
          condition: { lambda: "return id(d1_sub).state > 0;" }
          then:
            - light.turn_on:
                id: p1
                brightness: !lambda "return id(p1_speed).state / 100.0;"
            - delay: !lambda "return id(d1_sub).state * id(c1).state * 1000;"
            - light.turn_off: p1
            - lambda: "id(p1_level).publish_state(max(0.0f, id(p1_level).state - id(d1_sub).state));"
            - delay: 1s

      # --- POMPA 2 ---
      - if:
          condition: { lambda: "return id(d2_sub).state > 0;" }
          then:
            - light.turn_on:
                id: p2
                brightness: !lambda "return id(p2_speed).state / 100.0;"
            - delay: !lambda "return id(d2_sub).state * id(c2).state * 1000;"
            - light.turn_off: p2
            - lambda: "id(p2_level).publish_state(max(0.0f, id(p2_level).state - id(d2_sub).state));"
            - delay: 1s

      # --- POMPA 3 ---
      - if:
          condition: { lambda: "return id(d3_sub).state > 0;" }
          then:
            - light.turn_on:
                id: p3
                brightness: !lambda "return id(p3_speed).state / 100.0;"
            - delay: !lambda "return id(d3_sub).state * id(c3).state * 1000;"
            - light.turn_off: p3
            - lambda: "id(p3_level).publish_state(max(0.0f, id(p3_level).state - id(d3_sub).state));"
            - delay: 1s

      # --- POMPA 4 ---
      - if:
          condition: { lambda: "return id(d4_sub).state > 0;" }
          then:
            - light.turn_on:
                id: p4
                brightness: !lambda "return id(p4_speed).state / 100.0;"
            - delay: !lambda "return id(d4_sub).state * id(c4).state * 1000;"
            - light.turn_off: p4
            - lambda: "id(p4_level).publish_state(max(0.0f, id(p4_level).state - id(d4_sub).state));"
            - delay: 1s

      # --- POMPA 5 ---
      - if:
          condition: { lambda: "return id(d5_sub).state > 0;" }
          then:
            - light.turn_on:
                id: p5
                brightness: !lambda "return id(p5_speed).state / 100.0;"
            - delay: !lambda "return id(d5_sub).state * id(c5).state * 1000;"
            - light.turn_off: p5
            - lambda: "id(p5_level).publish_state(max(0.0f, id(p5_level).state - id(d5_sub).state));"
            - delay: 1s

      # --- POMPA 6 ---
      - if:
          condition: { lambda: "return id(d6_sub).state > 0;" }
          then:
            - light.turn_on:
                id: p6
                brightness: !lambda "return id(p6_speed).state / 100.0;"
            - delay: !lambda "return id(d6_sub).state * id(c6).state * 1000;"
            - light.turn_off: p6
            - lambda: "id(p6_level).publish_state(max(0.0f, id(p6_level).state - id(d6_sub).state));"
            - delay: 1s

      - lambda: "global_preferences->sync();"
      - logger.log: "INFO: Pełne nawożenie po podmianie zakończone sukcesem."



display:
  - platform: lcd_pcf8574
    dimensions: 20x4
    address: 0x27
    id: my_display
    lambda: |-
      // Linia 1: Data i Godzina (20 znaków)
      it.strftime(0, 0, "%d.%m.%Y  %H:%M:%S", id(ds_time).now());
      
      // Linia 2: Rotacja butelek (z funkcją MX dla 100%)
      if ((millis() % 10000) < 5000) {
        // Pompy 1, 2, 3
        float p1 = id(p1_level).state / 10.0;
        float p2 = id(p2_level).state / 10.0;
        float p3 = id(p3_level).state / 10.0;
        
        it.printf(0, 1, "P1:%s%% P2:%s%% P3:%s%%", 
          (p1 >= 100.0 ? "MX" : str_sprintf("%2.0f", p1).c_str()),
          (p2 >= 100.0 ? "MX" : str_sprintf("%2.0f", p2).c_str()),
          (p3 >= 100.0 ? "MX" : str_sprintf("%2.0f", p3).c_str()));
      } else {
        // Pompy 4, 5, 6
        float p4 = id(p4_level).state / 10.0;
        float p5 = id(p5_level).state / 10.0;
        float p6 = id(p6_level).state / 10.0;
        
        it.printf(0, 1, "P4:%s%% P5:%s%% P6:%s%%", 
          (p4 >= 100.0 ? "MX" : str_sprintf("%2.0f", p4).c_str()),
          (p5 >= 100.0 ? "MX" : str_sprintf("%2.0f", p5).c_str()),
          (p6 >= 100.0 ? "MX" : str_sprintf("%2.0f", p6).c_str()));
      }
      
      // Linia 3: PH i Temperatura (rozdzielone, z dużą ilością miejsca)
      it.printf(0, 2, "PH:%4.2f  Temp:%4.1fC", 
        id(ph_akwarium).state, id(temp_akwarium).state);
      
      // Linia 4: TDS i Info o zbiorniku
      it.printf(0, 3, "TDS:%3.0f ppm", id(tds_real).state);


      it.printf(14, 3, "%c%c%c%c%c%c", 
        id(p1).remote_values.is_on() ? '1' : '.',
        id(p2).remote_values.is_on() ? '2' : '.',
        id(p3).remote_values.is_on() ? '3' : '.',
        id(p4).remote_values.is_on() ? '4' : '.',
        id(p5).remote_values.is_on() ? '5' : '.',
        id(p6).remote_values.is_on() ? '6' : '.');

# --- WIZUALIZACJA I SENSORY ---
text_sensor:
  # 1. Główny czas z modułu RTC (ten steruje pompami)
  - platform: template
    name: "00. CZAS: Zegar RTC"
    id: time_rtc_sensor
    lambda: 'return id(ds_time).now().strftime("%H:%M:%S");'
    update_interval: 1s

  # 2. Czas pobrany bezpośrednio z internetu (NTP)
  - platform: template
    name: "00. CZAS: Internet (NTP)"
    id: time_ntp_sensor
    lambda: |-
      if (id(sntp_time).now().is_valid()) {
        return id(sntp_time).now().strftime("%H:%M:%S");
      } else {
        return {"Synchronizacja..."};
      }
    update_interval: 1s

  # 3. Data systemowa
  - platform: template
    name: "00. SYSTEM: Data"
    lambda: 'return id(ds_time).now().strftime("%Y-%m-%d");'
    update_interval: 60s


  - platform: template
    name: "02. POZIOM: Mikro [P1]"
    id: bar_p1
    lambda: |-
      int dots = (id(p1_level).state / 1000.0) * 10.0;
      std::string bar = "[";
      for(int i=0; i<10; i++) { if(i < dots) bar += "█"; else bar += "░"; }
      bar += "] " + to_string((int)((id(p1_level).state / 1000.0) * 100.0)) + "%";
      return bar;
    update_interval: 5s

  - platform: template
    name: "02. POZIOM: KNO3 [P2]"
    id: bar_p2
    lambda: |-
      int dots = (id(p2_level).state / 1000.0) * 10.0;
      std::string bar = "[";
      for(int i=0; i<10; i++) { if(i < dots) bar += "█"; else bar += "░"; }
      bar += "] " + to_string((int)((id(p2_level).state / 1000.0) * 100.0)) + "%";
      return bar;
    update_interval: 5s

  - platform: template
    name: "02. POZIOM: K2SO4 [P3]"
    id: bar_p3
    lambda: |-
      int dots = (id(p3_level).state / 1000.0) * 10.0;
      std::string bar = "[";
      for(int i=0; i<10; i++) { if(i < dots) bar += "█"; else bar += "░"; }
      bar += "] " + to_string((int)((id(p3_level).state / 1000.0) * 100.0)) + "%";
      return bar;
    update_interval: 5s

  - platform: template
    name: "02. POZIOM: Carbo [P4]"
    id: bar_p4
    lambda: |-
      int dots = (id(p4_level).state / 1000.0) * 10.0;
      std::string bar = "[";
      for(int i=0; i<10; i++) { if(i < dots) bar += "█"; else bar += "░"; }
      bar += "] " + to_string((int)((id(p4_level).state / 1000.0) * 100.0)) + "%";
      return bar;
    update_interval: 5s

  - platform: template
    name: "02. POZIOM: MgSO4 [P5]"
    id: bar_p5
    lambda: |-
      int dots = (id(p5_level).state / 1000.0) * 10.0;
      std::string bar = "[";
      for(int i=0; i<10; i++) { if(i < dots) bar += "█"; else bar += "░"; }
      bar += "] " + to_string((int)((id(p5_level).state / 1000.0) * 100.0)) + "%";
      return bar;
    update_interval: 5s

  - platform: template
    name: "02. POZIOM: MAKRO [P6]"
    id: bar_p6
    lambda: |-
      int dots = (id(p6_level).state / 1000.0) * 10.0;
      std::string bar = "[";
      for(int i=0; i<10; i++) { if(i < dots) bar += "█"; else bar += "░"; }
      bar += "] " + to_string((int)((id(p6_level).state / 1000.0) * 100.0)) + "%";
      return bar;
    update_interval: 5s

# --- KONFIGURACJA LICZBOWA (BOX) ---    
number:
  # POJEMNIKI (1000ml)
  - platform: template
    name: "02. BUTELKA: P1 (ml)"
    id: p1_level
    mode: BOX
    min_value: 0
    max_value: 1000
    step: 1
    optimistic: true
    restore_value: yes
    initial_value: 1000

  - platform: template
    name: "02. BUTELKA: P2 (ml)"
    id: p2_level
    mode: BOX
    min_value: 0
    max_value: 1000
    step: 1
    optimistic: true
    restore_value: yes
    initial_value: 1000

  - platform: template
    name: "02. BUTELKA: P3 (ml)"
    id: p3_level
    mode: BOX
    min_value: 0
    max_value: 1000
    step: 1
    optimistic: true
    restore_value: yes
    initial_value: 1000
    

  - platform: template
    name: "02. BUTELKA: P4 (ml)"
    id: p4_level
    mode: BOX
    min_value: 0
    max_value: 1000
    step: 1
    optimistic: true
    restore_value: yes
    initial_value: 1000
    

  - platform: template
    name: "02. BUTELKA: P5 (ml)"
    id: p5_level
    mode: BOX
    min_value: 0
    max_value: 1000
    step: 1
    optimistic: true
    restore_value: yes
    initial_value: 1000
    

  - platform: template
    name: "02. BUTELKA: P6 (ml)"
    id: p6_level
    mode: BOX
    min_value: 0
    max_value: 1000
    step: 1
    optimistic: true
    restore_value: yes
    initial_value: 1000
    

  # KALIBRACJA
  - platform: template
    name: "03. KALIB: P1 (s/ml)"
    id: c1
    mode: BOX
    min_value: 0
    max_value: 20
    step: 0.01
    initial_value: 3.0
    optimistic: true
    restore_value: yes
  - platform: template
    name: "03. KALIB: P2 (s/ml)"
    id: c2
    mode: BOX
    min_value: 0
    max_value: 20
    step: 0.01
    initial_value: 3.0
    optimistic: true
    restore_value: yes
  - platform: template
    name: "03. KALIB: P3 (s/ml)"
    id: c3
    mode: BOX
    min_value: 0
    max_value: 20
    step: 0.01
    initial_value: 3.0
    optimistic: true
    restore_value: yes
  - platform: template
    name: "03. KALIB: P4 (s/ml)"
    id: c4
    mode: BOX
    min_value: 0
    max_value: 20
    step: 0.01
    initial_value: 3.0
    optimistic: true
    restore_value: yes
  - platform: template
    name: "03. KALIB: P5 (s/ml)"
    id: c5
    mode: BOX
    min_value: 0
    max_value: 20
    step: 0.01
    initial_value: 3.0
    optimistic: true
    restore_value: yes
  - platform: template
    name: "03. KALIB: P6 (s/ml)"
    id: c6
    mode: BOX
    min_value: 0
    max_value: 20
    step: 0.01
    initial_value: 3.0
    optimistic: true
    restore_value: yes

  # DAWKI
  - platform: template
    name: "04. DAWKA: P1 (ml)"
    id: d1
    mode: BOX
    min_value: 0
    max_value: 100
    step: 0.1
    optimistic: true
    restore_value: yes
  - platform: template
    name: "04. DAWKA: P2 (ml)"
    id: d2
    mode: BOX
    min_value: 0
    max_value: 100
    step: 0.1
    optimistic: true
    restore_value: yes
  - platform: template
    name: "04. DAWKA: P3 (ml)"
    id: d3
    mode: BOX
    min_value: 0
    max_value: 100
    step: 0.1
    optimistic: true
    restore_value: yes
  - platform: template
    name: "04. DAWKA: P4 (ml)"
    id: d4
    mode: BOX
    min_value: 0
    max_value: 100
    step: 0.1
    optimistic: true
    restore_value: yes
  - platform: template
    name: "04. DAWKA: P5 (ml)"
    id: d5
    mode: BOX
    min_value: 0
    max_value: 100
    step: 0.1
    optimistic: true
    restore_value: yes
  - platform: template
    name: "04. DAWKA: P6 (ml)"
    id: d6
    mode: BOX
    min_value: 0
    max_value: 100
    step: 0.1
    optimistic: true
    restore_value: yes

  # GODZINY
  - platform: template
    name: "05. CZAS: P1 (h)"
    id: h_p1
    mode: BOX
    min_value: 0
    max_value: 23
    step: 1
    optimistic: true
    restore_value: yes
  - platform: template
    name: "05. CZAS: P2 (h)"
    id: h_p2
    mode: BOX
    min_value: 0
    max_value: 23
    step: 1
    optimistic: true
    restore_value: yes
  - platform: template
    name: "05. CZAS: P3 (h)"
    id: h_p3
    mode: BOX
    min_value: 0
    max_value: 23
    step: 1
    optimistic: true
    restore_value: yes
  - platform: template
    name: "05. CZAS: P4 (h)"
    id: h_p4
    mode: BOX
    min_value: 0
    max_value: 23
    step: 1
    optimistic: true
    restore_value: yes
  - platform: template
    name: "05. CZAS: P5 (h)"
    id: h_p5
    mode: BOX
    min_value: 0
    max_value: 23
    step: 1
    optimistic: true
    restore_value: yes
  - platform: template
    name: "05. CZAS: P6 (h)"
    id: h_p6
    mode: BOX
    min_value: 0
    max_value: 23
    step: 1
    optimistic: true
    restore_value: yes
  # MINUTY DOZOWANIA (P1 - P6)
  - platform: template
    name: "05. CZAS: P1 (min)"
    id: m_p1
    mode: BOX
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    restore_value: yes
  - platform: template
    name: "05. CZAS: P2 (min)"
    id: m_p2
    mode: BOX
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    restore_value: yes
  - platform: template
    name: "05. CZAS: P3 (min)"
    id: m_p3
    mode: BOX
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    restore_value: yes
  - platform: template
    name: "05. CZAS: P4 (min)"
    id: m_p4
    mode: BOX
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    restore_value: yes
  - platform: template
    name: "05. CZAS: P5 (min)"
    id: m_p5
    mode: BOX
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    restore_value: yes
  - platform: template
    name: "05. CZAS: P6 (min)"
    id: m_p6
    mode: BOX
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    restore_value: yes

#  PRĘDKOŚCI POMP
  - platform: template
    name: "P1: Prędkość %"
    id: p1_speed
    min_value: 30
    max_value: 100
    step: 1
    optimistic: true
    initial_value: 100
    restore_value: true
    unit_of_measurement: "%"
    mode: box

  - platform: template
    name: "P2: Prędkość %"
    id: p2_speed
    min_value: 30
    max_value: 100
    step: 1
    optimistic: true
    initial_value: 100
    restore_value: true
    unit_of_measurement: "%"
    mode: box

  - platform: template
    name: "P3: Prędkość %"
    id: p3_speed
    min_value: 30
    max_value: 100
    step: 1
    optimistic: true
    initial_value: 100
    restore_value: true
    unit_of_measurement: "%"
    mode: box

  - platform: template
    name: "P4: Prędkość %"
    id: p4_speed
    min_value: 30
    max_value: 100
    step: 1
    optimistic: true
    initial_value: 100
    restore_value: true
    unit_of_measurement: "%"
    mode: box

  - platform: template
    name: "P5: Prędkość %"
    id: p5_speed
    min_value: 30
    max_value: 100
    step: 1
    optimistic: true
    initial_value: 100
    restore_value: true
    unit_of_measurement: "%"
    mode: box

  - platform: template
    name: "P6: Prędkość %"
    id: p6_speed
    min_value: 30
    max_value: 100
    step: 1
    optimistic: true
    initial_value: 100
    restore_value: true
    unit_of_measurement: "%"
    mode: box

# DAWKI UDERZENIOWE DLA WSZYSTKICH POMP (PO PODMIANIE)
  - platform: template
    name: "06. PODMIANA: P1 Mikro (ml)"
    id: d1_sub
    mode: BOX
    min_value: 0
    max_value: 100
    step: 0.1
    optimistic: true
    restore_value: yes
    initial_value: 5.0

  - platform: template
    name: "06. PODMIANA: P2 Azot (ml)"
    id: d2_sub
    mode: BOX
    min_value: 0
    max_value: 100
    step: 0.1
    optimistic: true
    restore_value: yes
    initial_value: 15.0

  - platform: template
    name: "06. PODMIANA: P3 Potas (ml)"
    id: d3_sub
    mode: BOX
    min_value: 0
    max_value: 100
    step: 0.1
    optimistic: true
    restore_value: yes
    initial_value: 10.0

  - platform: template
    name: "06. PODMIANA: P4 Carbo (ml)"
    id: d4_sub
    mode: BOX
    min_value: 0
    max_value: 100
    step: 0.1
    optimistic: true
    restore_value: yes
    initial_value: 3.0

  - platform: template
    name: "06. PODMIANA: P5 MgSO4 (ml)"
    id: d5_sub
    mode: BOX
    min_value: 0
    max_value: 100
    step: 0.1
    optimistic: true
    restore_value: yes
    initial_value: 0.0

  - platform: template
    name: "06. PODMIANA: P6 MAKRO (ml)"
    id: d6_sub
    mode: BOX
    min_value: 0
    max_value: 100
    step: 0.1
    optimistic: true
    restore_value: yes
    initial_value: 0.0


switch:
  # POMPA 1 - DNI TYGODNIA
  - platform: template
    name: "P1: Poniedziałek"
    id: p1_mon
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P1: Wtorek"
    id: p1_tue
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P1: Środa"
    id: p1_wed
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P1: Czwartek"
    id: p1_thu
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P1: Piątek"
    id: p1_fri
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P1: Sobota"
    id: p1_sat
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P1: Niedziela"
    id: p1_sun
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF

  # POMPA 2 - DNI TYGODNIA
  - platform: template
    name: "P2: Poniedziałek"
    id: p2_mon
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P2: Wtorek"
    id: p2_tue
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P2: Środa"
    id: p2_wed
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P2: Czwartek"
    id: p2_thu
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P2: Piątek"
    id: p2_fri
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P2: Sobota"
    id: p2_sat
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P2: Niedziela"
    id: p2_sun
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF

  # POMPA 3 - DNI TYGODNIA
  - platform: template
    name: "P3: Poniedziałek"
    id: p3_mon
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P3: Wtorek"
    id: p3_tue
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P3: Środa"
    id: p3_wed
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P3: Czwartek"
    id: p3_thu
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P3: Piątek"
    id: p3_fri
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P3: Sobota"
    id: p3_sat
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P3: Niedziela"
    id: p3_sun
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF

  # POMPA 4 - DNI TYGODNIA
  - platform: template
    name: "P4: Poniedziałek"
    id: p4_mon
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P4: Wtorek"
    id: p4_tue
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P4: Środa"
    id: p4_wed
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P4: Czwartek"
    id: p4_thu
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P4: Piątek"
    id: p4_fri
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P4: Sobota"
    id: p4_sat
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P4: Niedziela"
    id: p4_sun
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF

  # POMPA 5 - DNI TYGODNIA
  - platform: template
    name: "P5: Poniedziałek"
    id: p5_mon
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P5: Wtorek"
    id: p5_tue
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P5: Środa"
    id: p5_wed
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P5: Czwartek"
    id: p5_thu
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P5: Piątek"
    id: p5_fri
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P5: Sobota"
    id: p5_sat
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P5: Niedziela"
    id: p5_sun
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF

  # POMPA 6 - DNI TYGODNIA
  - platform: template
    name: "P6: Poniedziałek"
    id: p6_mon
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P6: Wtorek"
    id: p6_tue
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P6: Środa"
    id: p6_wed
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P6: Czwartek"
    id: p6_thu
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P6: Piątek"
    id: p6_fri
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P6: Sobota"
    id: p6_sat
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
  - platform: template
    name: "P6: Niedziela"
    id: p6_sun
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF

# --- PRZYCISKI (Zaktualizowane o osobne REFILL) ---
button:
  # Sekcja A - Ręczne dozowanie dawki ustawionej w polu DAWKA
  - platform: template
    name: "A. DOZUJ: P1"
    on_press: [script.execute: script_p1]
  - platform: template
    name: "A. DOZUJ: P2"
    on_press: [script.execute: script_p2]
  - platform: template
    name: "A. DOZUJ: P3"
    on_press: [script.execute: script_p3]
  - platform: template
    name: "A. DOZUJ: P4"
    on_press: [script.execute: script_p4]
  - platform: template
    name: "A. DOZUJ: P5"
    on_press: [script.execute: script_p5]
  - platform: template
    name: "A. DOZUJ: P6"
    on_press: [script.execute: script_p6]

  # Sekcja B - Resetowanie poziomu butelki dla każdej pompy z osobna
  - platform: template
    name: "B. REFILL: P1 (1000ml)"
    on_press: 
      - lambda: |-
          id(p1_level).publish_state(1000.0);
          global_preferences->sync(); // <--- Zapisz reset butelki
  - platform: template
    name: "B. REFILL: P2 (1000ml)"
    on_press: 
      - lambda: |-
          id(p2_level).publish_state(1000.0);
          global_preferences->sync(); // <--- Zapisz reset butelki
  - platform: template
    name: "B. REFILL: P3 (1000ml)"
    on_press: 
      - lambda: |-
          id(p3_level).publish_state(1000.0);
          global_preferences->sync(); // <--- Zapisz reset butelki
  - platform: template
    name: "B. REFILL: P4 (1000ml)"
    on_press: 
      - lambda: |-
          id(p4_level).publish_state(1000.0);
          global_preferences->sync(); // <--- Zapisz reset butelki
  - platform: template
    name: "B. REFILL: P5 (1000ml)"
    on_press: 
      - lambda: |-
          id(p5_level).publish_state(1000.0);
          global_preferences->sync(); // <--- Zapisz reset butelki
  - platform: template
    name: "B. REFILL: P6 (1000ml)"
    on_press: 
      - lambda: |-
          id(p6_level).publish_state(1000.0);
          global_preferences->sync(); // <--- Zapisz reset butelki

  # Przycisk zbiorczy dla wygody
  - platform: template
    name: "B. REFILL: Wszystkie (1000ml)"
    on_press:
      - lambda: |-
          id(p1_level).publish_state(1000.0);
          id(p2_level).publish_state(1000.0);
          id(p3_level).publish_state(1000.0);
          id(p4_level).publish_state(1000.0);
          id(p5_level).publish_state(1000.0);
          id(p6_level).publish_state(1000.0);
          global_preferences->sync(); // <--- Zapisuje wszystkie 6 butelek jednym ruchem

  - platform: template
    name: "D. PODMIANA: Uruchom wyrównanie P1-P6"
    icon: "mdi:water-boiler-auto"
    on_press:
      - script.execute: script_podmiana_uderzenie

  - platform: template
    name: "C. TEST 10s: P1"
    on_press:
      - light.turn_on:
          id: p1
          brightness: !lambda "return id(p1_speed).state / 100.0;"
      - delay: 10s
      - light.turn_off: p1

  - platform: template
    name: "C. TEST 10s: P2"
    on_press: 
      - light.turn_on:
          id: p2
          brightness: !lambda "return id(p2_speed).state / 100.0;"
      - delay: 10s
      - light.turn_off: p2

  - platform: template
    name: "C. TEST 10s: P3"
    on_press: 
      - light.turn_on:
          id: p3
          brightness: !lambda "return id(p3_speed).state / 100.0;"
      - delay: 10s
      - light.turn_off: p3
  
  - platform: template
    name: "C. TEST 10s: P4"
    on_press: 
      - light.turn_on:
          id: p4
          brightness: !lambda "return id(p4_speed).state / 100.0;"
      - delay: 10s
      - light.turn_off: p4

  - platform: template
    name: "C. TEST 10s: P5"
    on_press: 
      - light.turn_on:
          id: p5
          brightness: !lambda "return id(p5_speed).state / 100.0;"
      - delay: 10s
      - light.turn_off: p5

  - platform: template
    name: "C. TEST 10s: P6"
    on_press: 
      - light.turn_on:
          id: p6
          brightness: !lambda "return id(p6_speed).state / 100.0;"
      - delay: 10s
      - light.turn_off: p6

# --- WYJŚCIA FIZYCZNE ---
output:
  - platform: ledc
    pin: 13
    id: out_p1
  - platform: ledc
    pin: 16
    id: out_p2
  - platform: ledc
    pin: 14
    id: out_p3
  - platform: ledc
    pin: 27
    id: out_p4
  - platform: ledc
    pin: 26
    id: out_p5
  - platform: ledc
    pin: 25
    id: out_p6

light:
  - platform: monochromatic
    output: out_p1
    name: "Pompa 1"
    id: p1
    default_transition_length: 1s
  - platform: monochromatic
    output: out_p2
    name: "Pompa 2"
    id: p2
    default_transition_length: 1s
  - platform: monochromatic
    output: out_p3
    name: "Pompa 3"
    id: p3
    default_transition_length: 1s
  - platform: monochromatic
    output: out_p4
    name: "Pompa 4"
    id: p4
    default_transition_length: 1s
  - platform: monochromatic
    output: out_p5
    name: "Pompa 5"
    id: p5
    default_transition_length: 1s
  - platform: monochromatic
    output: out_p6
    name: "Pompa 6"
    id: p6
    default_transition_length: 1s